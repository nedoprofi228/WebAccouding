<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Таблица отчетов</title>
    <style>
        /* Стили для таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr {
            position: relative;
        }
        tr:hover {
            background-color: #f5f5f5;
            cursor: pointer;
        }

        /* Стили для кнопки удаления в строке таблицы */
        .delete-report-btn {
            display: none;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            z-index: 10;
        }
        .admin tr:hover .delete-report-btn {
            display: block;
        }

        /* Стили для детальной информации */
        .report-details {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
        }
        .item {
            position: relative;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
        }
        .delete-btn {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        .admin .item:hover .delete-btn {
            display: block;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 10px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #45a049;
        }
        /* Стили для новых таблиц */
        .summary-table {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<button class="btn" onclick="location.href='/'">на главную</button>
<h1>Таблица отчетов</h1>

<!-- Кнопки для выбора типа предмета -->
<button id="loadEquipment">Оборудование</button>
<button id="loadOfficeEquipment">Офисное оборудование</button>
<button id="loadPreciousMetals">Драгоценные металлы</button>

<!-- Таблица отчетов -->
<table id="reportsTable">
    <thead>
    <tr>
        <th>Id</th>
        <th>Дата</th>
        <th>Имя тикета</th>
        <th>Статус тикета</th>
        <th>Общая стоимость</th>
        <th>Статус предметов</th>
        <th>Менеджер</th>
    </tr>
    </thead>
    <tbody>
    <!-- Здесь будут строки -->
    </tbody>
</table>

<!-- Детальная информация об отчете -->
<div id="reportDetails" class="report-details" style="display:none;">
    <!-- Здесь будет подробная информация -->
</div>

<!-- Таблицы для итоговых расчетов -->
<div id="summaryTables">
    <h2>Итоговые расчеты</h2>
    <table id="costSummaryTable" class="summary-table">
        <thead>
        <tr>
            <th>Тип</th>
            <th>Общая стоимость</th>
            <th>Общее количество</th>
        </tr>
        </thead>
        <tbody>
        <!-- Здесь будут данные по стоимости -->
        </tbody>
    </table>

    <table id="preciousMetalsTable" class="summary-table">
        <thead>
        <tr>
            <th>Тип металла</th>
            <th>Общий вес</th>
        </tr>
        </thead>
        <tbody>
        <!-- Здесь будут данные по драгметаллам -->
        </tbody>
    </table>
    
</div>

<!-- JavaScript -->
<script>

    // Обработчики кликов на кнопки
    document.getElementById('loadEquipment').addEventListener('click', () => reportsAction('equipment', displayReports));
    document.getElementById('loadOfficeEquipment').addEventListener('click', () => reportsAction('officeEquipment', displayReports));
    document.getElementById('loadPreciousMetals').addEventListener('click', () => reportsAction('preciousMetals', displayReports));
    const tbody = document.querySelector('#reportsTable tbody');
    const detailsDiv = document.getElementById('reportDetails');
    const costSummaryTableBody = document.querySelector('#costSummaryTable tbody');
    const preciousMetalsTableBody = document.querySelector('#preciousMetalsTable tbody');
    let equipmentCost = 0;
    let equipmentCount = 0;
    const preciousMetals = {};
    
    Main();
    async function Main(){
        await reportsAction('equipment', calculateSummaries)
        await reportsAction('officeEquipment', calculateSummaries)
        await reportsAction('preciousMetals', calculateSummaries)
    
        if (equipmentCost > 0) {
            const equipmentRow = document.createElement('tr');
            equipmentRow.innerHTML = `
                <td>Оборудование</td>
                <td>${equipmentCost.toFixed(2)}</td>
                <td>${equipmentCount}</td>
            `;
            costSummaryTableBody.appendChild(equipmentRow);
        }
    
    
        // Заполнение таблицы драгоценных металлов
    
            for (const [metal, weight] of Object.entries(preciousMetals)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${metal}</td>
                    <td>${weight.toFixed(2)}</td>
                `;
                preciousMetalsTableBody.appendChild(row);
            }
        }
    

    // Функция для загрузки отчетов с сервера
    async function reportsAction(type, action) {
        try {
            tbody.innerHTML = '';
            detailsDiv.innerHTML = '';
            const response = await fetch(`/accoudings/${type}`);
            if (!response.ok) throw new Error('Ошибка загрузки данных');
            const reports = await response.json();
            action(reports, type);
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    // Функция для отображения отчетов в таблице
    function displayReports(reports, type) {
        tbody.innerHTML = ''; // Очистка таблицы
        reports.forEach(report => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-type', type);
            tr.setAttribute('data-report-id', report.Id);

            // Добавляем кнопку удаления отчета
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-report-btn';
            deleteBtn.textContent = '×';
            deleteBtn.title = 'Удалить отчет';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Предотвращаем всплытие события
                deleteReport(report.Id, type);
            });

            tr.innerHTML = `
                    <td>${report.Id}</td>
                    <td>${new Date(report.Date).toLocaleDateString()}</td>
                    <td>${report.Ticket.Name}</td>
                    <td>${report.Ticket.TicketStatus}</td>
                    <td>${report.Ticket.TotalPrice}</td>
                    <td>${report.Ticket.ItemStatus}</td>
                    <td>${report.Manager.Name}</td>
                `;
            tr.appendChild(deleteBtn);
            tr.addEventListener('click', () => showReportDetails(report, type));
            tbody.appendChild(tr);
        });
    }

    // Функция для удаления отчета
    async function deleteReport(reportId, type) {
        if (confirm('Вы уверены, что хотите удалить этот отчет?')) {
            try {
                const response = await fetch(`/accoudings/${type}/${reportId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Ошибка удаления отчета');
                showReports(type); // Перезагружаем список отчетов
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Не удалось удалить отчет');
            }
        }
    }

    // Функция для отображения подробной информации об отчете
    function showReportDetails(report, type) {
        detailsDiv.innerHTML = `
                <h3>Отчет Id: ${report.Id}</h3>
                <p><strong>Дата:</strong> ${new Date(report.Date).toLocaleDateString()}</p>
                <p><strong>Имя тикета:</strong> ${report.Ticket.Name}</p>
                <p><strong>Общая стоимость:</strong> ${report.Ticket.TotalPrice}</p>
                <p><strong>Статус предметов:</strong> ${report.Ticket.ItemStatus}</p>
                <p><strong>Менеджер:</strong> ${report.Manager.Name}</p>
                <h4>Предметы:</h4>
                <div id="itemsList"></div>
            `;
        const itemsList = document.getElementById('itemsList');
        report.Ticket.Items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('item');
            itemDiv.setAttribute('data-item-id', item.Name);

            let itemHtml = '';
            switch (type) {
                case 'equipment':
                    itemHtml = `
                            <h5>Оборудование</h5>
                            <ul>
                                <li><strong>Название:</strong> ${item.Name}</li>
                                <li><strong>Цена:</strong> ${item.Price}</li>
                            </ul>
                        `;
                    break;
                case 'officeEquipment':
                    itemHtml = `
                            <h5>Офисное оборудование</h5>
                            <ul>
                                <li><strong>Название:</strong> ${item.Name}</li>
                                <li><strong>Цена:</strong> ${item.Price}</li>
                                <li><strong>Тип принтера:</strong> ${item.PrinterType}</li>
                            </ul>
                        `;
                    break;
                case 'preciousMetals':
                    itemHtml = `
                            <h5>Драгоценные металлы</h5>
                            <ul>
                                <li><strong>Название:</strong> ${item.Name}</li>
                                <li><strong>Цена:</strong> ${item.Price}</li>
                                <li><strong>Вес:</strong> ${item.Weight}</li>
                                <li><strong>Драгоценность:</strong> ${item.Precious}</li>
                            </ul>
                        `;
                    break;
            }

            itemDiv.innerHTML = itemHtml;
            itemsList.appendChild(itemDiv);
        });
        detailsDiv.style.display = 'block';
    }

    // Функция для расчета и отображения итоговых таблиц
    function calculateSummaries(reports, type) {

        reports.forEach(report => {
            if (report.Ticket.TicketStatus === 'Accepted' && (type === 'equipment' || type === 'officeEquipment')) {
                const items = report.Ticket.Items;
                equipmentCost += report.Ticket.TotalPrice;
                items.forEach(item => {
                    const price = parseFloat(item.Price);
                    console.log(`Элемент: ${item.Name}, Цена: ${item.Price}, После parseFloat: ${price}`); // Отладка
                    if (type === 'equipment' || type === "officeEquipment") {
                        equipmentCount++;
                    }
                });
            } else if (report.Ticket.TicketStatus === 'Accepted' && type === 'preciousMetals') {
                const items = report.Ticket.Items;
                items.forEach(item => {
                    if (item.Precious && item.Weight) {
                        if (!preciousMetals[item.Precious]) {
                            preciousMetals[item.Precious] = 0;
                        }
                        preciousMetals[item.Precious] += parseFloat(item.Weight) || 0;
                    }
                });
            }
        });

        console.log(`Тип: ${type}, equipmentCost: ${equipmentCost}`); // Отладка
        

    }
</script>
</body>
</html>